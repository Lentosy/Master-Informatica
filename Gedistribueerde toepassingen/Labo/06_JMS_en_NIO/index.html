<h2>JAVA NIO and JMS</h2>

<p>In this lab we are going to focus on two topics: JAVA NIO and JMS through the design and the

implementation of a Auction Server and two Auction Consumers in Netbeans, see the figure below.</p>

<img src="Auction.png" alt="auction" width="400">

<h3>Database and data tier</h3>

<p>The server uses a Java DB database with auction items. Make and populate  a database using Netbeans with the following scripts.

<ol>

<li><a href="createAuction.sql">createAuction.sql</a>: makes a table <code>auction</code>.</li>

<li><a href="auction.sql">auction.sql</a>: populates the table <code>auction</code> with items to be sold.</li>

</ol>

For more information on the use of Java DB in Netbeans see <a href="https://netbeans.org/features/ide/database.html">https://netbeans.org/features/ide/database.html</a>. Check in the window <b>services</b> whether the Java DB and Glassfish are activated. If that is not the case, create a new (empty) web project. Both are then activated.
</p>

<p>The classes <a href="Auction.java">Auction</a>, <a href="Item.java">Item</a> and <a href="Offer.java">Offer</a> are given. They provide the required functionality to connect to the database, to pick a random item and to check whether an offer is accepted. </p>

<p><code>Auction</code> uses a DataSource with the JNDI name <code>jdbc/auction</code>. You have to configure a DataSource in Glassfish with this JNDI name that connects to the database you have created. See for instance <a href="https://docs.oracle.com/cd/E19316-01/820-4335/gibzk/index.html">https://docs.oracle.com/cd/E19316-01/820-4335/gibzk/index.html</a>. Use the command line interface <b>asadmin</b> to <a href="https://docs.oracle.com/cd/E26576_01/doc.312/e24938/create-jdbc-connection-pool.htm#GSRFM00036">create a connection pool</a> and <a href="https://docs.oracle.com/cd/E26576_01/doc.312/e24938/create-jdbc-resource.htm#GSRFM00037">a datasource!</a> You can find the commandline tool asadmin in the bin directory of Glassfish. You may need to add the directory of the java jdk to the PATH environment variable. Test the given classes with a program of the type <b>appclient</b>. (see running the server below)</p>

<h3>JMS: Queue</h3>

<p>When an item is sold to one of the clients or when its not sold within a certain amount of time the server sends a message to a queue. You have to configure this queue in Glassfish. For more information using asadmin see <a href="https://docs.oracle.com/cd/E19798-01/821-1758/6nmnj7ptj/index.html">https://docs.oracle.com/cd/E19798-01/821-1758/6nmnj7ptj/index.html</a> (Example 2 Creating a JMS destination resource).</p>

<h3>AuctionServer</h3>

<p>The Server can accept the requests of several clients who are willing to offer on an item. 

The auction consists of several items and each client gets a limited time to offer on a particular item until the next item is offered for sale. The server can receive messages from any of those clients at any time and needs to process it. Use a selector to establish this.</p>

<p>The Server is the manager of the auction process, which is responsible for taking the following actions:</p>

<ul>

<li>Welcoming and registering new clients</li>

<li>Sending information of items for sale to the clients: <code>ITEM id description minimumPrice</code>.
If there's no offer for an item after one minute a new item will be offered for sale. If there is an offer from a client, then a client has one minute to make a better offer.</li>

<li>Processing clients' messages</li>

</ul>

<p>On the other hand, the client exchanges messages with the server for several purposes including

<ul>

<li>Registering for the auction: <code>REGISTER name</code></li>

<li>Make an offer: <code>OFFER  price</code></li>

<li>Quiting the auction: <code>QUIT</code></li>

</ul>

<p>Every time when the server offers an new item for sale, it attaches a message to the queue. The content of the message depends on whether the item is sold.

	<ul>

		<li><code>"NOT SOLD id LAST OFFER price"</code></li>

		<li><code>"ITEM id SOLD BY name FOR price"</code></li>

	</ul>

<h4>Running the server</h4>

<p>The server has to be able to use the datasource and the queue. Therefor it must run in a Glassfish environment. You can realize this with a Netbeans Project type "Entreprise Application Client" or use the command <a href="https://docs.oracle.com/cd/E19798-01/821-1758/6nmnj7q2k/index.html"><code>appclient</code></a>. This program is found in the directory <code>../glassfish-4.1/glassfish/bin</code>. Add this directory to the PATH environment variable. <!--' (for more information see <a href="http://www.troubleshooters.com/linux/prepostpath.htm">http://www.troubleshooters.com/linux/prepostpath.htm</a>).--></p>

<p>If Netbeans doesn't generate a jar (in a directory <code>dist</code>), run the "Build" command.</p>

<h4>Tip</h4>
<p>Use the classes <code>java.util.Timer</code> en <code>java.util.TimerTask</code>.</p>

<h4>Client</h4>

<p>You can use <code>nc</code> (linux) of <code>ncat</code> (windows) to simulate a client. Je vindt ncat op <a href="https://nmap.org/dist/nmap-7.70-win32.zip">https://nmap.org/download.html</a> (zip uitpakken en het commando ncat gebruiken).</p>

<h3>Auction Consumers</h3>

<p>The auction consumers process the messages out of the queue. One consumer handles all sold items, the other all unsold items.</p>
<p>Example output first consumer</p>
<img src="consumerSold.png" alt="sold items">
<p>Example output second consumer</p>
<img src="consumerNotSold.png" alt="unsold items">
